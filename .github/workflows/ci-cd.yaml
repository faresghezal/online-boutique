name: Build and Deploy Online Boutique

on:
  push:
    branches:
      - main

env:
  ACR_NAME: boutiqueterraform123
  RESOURCE_GROUP: rg-online-boutique
  AKS_CLUSTER: aks-online-boutique
  K8S_MANIFEST: ./online-boutique.yaml
  IMAGE_TAG: latest

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Get AKS credentials
      run: az aks get-credentials --resource-group $RESOURCE_GROUP --name $AKS_CLUSTER

    - name: Login to ACR
      run: az acr login --name $ACR_NAME

    # -------------------------
    # Build & Push Docker Images
    # -------------------------
    - name: Build & Push adservice
      run: |
        docker build -t $ACR_NAME/adservice:$IMAGE_TAG ./microservices-demo/src/adservice
        docker push $ACR_NAME/adservice:$IMAGE_TAG

    - name: Build & Push shoppingassistantservice
      run: |
        docker build -t $ACR_NAME/shoppingassistantservice:$IMAGE_TAG ./microservices-demo/src/shoppingassistantservice
        docker push $ACR_NAME/shoppingassistantservice:$IMAGE_TAG

    - name: Build & Push productcatalogservice
      run: |
        docker build -t $ACR_NAME/productcatalogservice:$IMAGE_TAG ./microservices-demo/src/productcatalogservice
        docker push $ACR_NAME/productcatalogservice:$IMAGE_TAG

    - name: Build & Push loadgenerator
      run: |
        docker build -t $ACR_NAME/loadgenerator:$IMAGE_TAG ./microservices-demo/src/loadgenerator
        docker push $ACR_NAME/loadgenerator:$IMAGE_TAG

    - name: Build & Push checkoutservice
      run: |
        docker build -t $ACR_NAME/checkoutservice:$IMAGE_TAG ./microservices-demo/src/checkoutservice
        docker push $ACR_NAME/checkoutservice:$IMAGE_TAG

    - name: Build & Push frontend
      run: |
        docker build -t $ACR_NAME/frontend:$IMAGE_TAG ./microservices-demo/src/frontend
        docker push $ACR_NAME/frontend:$IMAGE_TAG

    - name: Build & Push currencyservice
      run: |
        docker build -t $ACR_NAME/currencyservice:$IMAGE_TAG ./microservices-demo/src/currencyservice
        docker push $ACR_NAME/currencyservice:$IMAGE_TAG

    - name: Build & Push emailservice
      run: |
        docker build -t $ACR_NAME/emailservice:$IMAGE_TAG ./microservices-demo/src/emailservice
        docker push $ACR_NAME/emailservice:$IMAGE_TAG

    - name: Build & Push cartservice
      run: |
        docker build -t $ACR_NAME/cartservice:$IMAGE_TAG ./microservices-demo/src/cartservice/src
        docker push $ACR_NAME/cartservice:$IMAGE_TAG

    - name: Build & Push recommendationservice
      run: |
        docker build -t $ACR_NAME/recommendationservice:$IMAGE_TAG ./microservices-demo/src/recommendationservice
        docker push $ACR_NAME/recommendationservice:$IMAGE_TAG

    - name: Build & Push shippingservice
      run: |
        docker build -t $ACR_NAME/shippingservice:$IMAGE_TAG ./microservices-demo/src/shippingservice
        docker push $ACR_NAME/shippingservice:$IMAGE_TAG

    - name: Build & Push paymentservice
      run: |
        docker build -t $ACR_NAME/paymentservice:$IMAGE_TAG ./microservices-demo/src/paymentservice
        docker push $ACR_NAME/paymentservice:$IMAGE_TAG

    # -------------------------
    # Deploy to AKS
    # -------------------------
    - name: Deploy to AKS
      run: |
        kubectl apply -f $K8S_MANIFEST
